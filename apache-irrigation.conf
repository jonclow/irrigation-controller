# Irrigation Controller - Apache Reverse Proxy Configuration
# This file should be placed at:
# /volume1/.@plugins/AppCentral/httpd-2.4.43/data/conf/sites-available/irrigation

# Listen on port 80
Listen 80

<VirtualHost *:80>
    ServerName 192.168.20.92
    ServerAdmin jonclow@redmercury.co.nz

    # Reverse proxy to Docker container
    ProxyPreserveHost On
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/

    # WebSocket support for Socket.IO
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)  ws://localhost:3000/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)  http://localhost:3000/$1 [P,L]

    # Proxy settings for WebSocket/Socket.IO
    ProxyPass /socket.io/ http://localhost:3000/socket.io/
    ProxyPassReverse /socket.io/ http://localhost:3000/socket.io/

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Logging
    ErrorLog /volume1/.@plugins/AppCentral/httpd-2.4.43/data/logs/irrigation-error.log
    CustomLog /volume1/.@plugins/AppCentral/httpd-2.4.43/data/logs/irrigation-access.log combined

    # Timeout settings (for long-running requests)
    ProxyTimeout 300
    Timeout 300
</VirtualHost>

# Optional: HTTPS on port 443 (if you have SSL certificate)
# Listen 443
# <VirtualHost *:443>
#     ServerName 192.168.20.92
#
#     SSLEngine on
#     SSLCertificateFile /path/to/cert.pem
#     SSLCertificateKeyFile /path/to/key.pem
#
#     # Same proxy configuration as above
#     ProxyPreserveHost On
#     ProxyPass / http://localhost:3000/
#     ProxyPassReverse / http://localhost:3000/
#
#     # WebSocket support
#     RewriteEngine On
#     RewriteCond %{HTTP:Upgrade} =websocket [NC]
#     RewriteRule /(.*)  ws://localhost:3000/$1 [P,L]
#
#     # Security headers
#     Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
#     Header always set X-Frame-Options "SAMEORIGIN"
#     Header always set X-Content-Type-Options "nosniff"
#     Header always set X-XSS-Protection "1; mode=block"
#
#     ErrorLog /volume1/.@plugins/AppCentral/httpd-2.4.43/data/logs/irrigation-ssl-error.log
#     CustomLog /volume1/.@plugins/AppCentral/httpd-2.4.43/data/logs/irrigation-ssl-access.log combined
# </VirtualHost>
