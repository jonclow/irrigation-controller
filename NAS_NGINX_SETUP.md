# NAS Nginx Proxy Configuration

## Overview

The Asustor NAS runs nginx (AppCentral) on port 80 which proxies requests to the React Router 7 frontend running in Docker on `localhost:3000`. ADM (Asustor Data Master) may periodically regenerate nginx configuration files, requiring the proxy configuration to be reapplied.

## Architecture

- **Frontend**: Docker container on NAS at `localhost:3000` (React Router 7 SSR)
- **Backend**: Raspberry Pi at `192.168.20.59:3001` (Node.js API)
- **Nginx**: AppCentral nginx proxies port 80 â†’ localhost:3000
- **Access**: `http://192.168.20.92/` (NAS IP)

## When Configuration Needs Reapplying

If you access `http://192.168.20.92/` and see the old static site instead of the React Router 7 app, the nginx config has been regenerated by ADM.

## Reconfiguration Steps

### 1. Verify Docker Container is Running

```bash
ssh nas
cd /volume1/Web/irrigation-frontend
docker compose -f docker-compose.nas.yml ps
```

The container should be healthy and listening on `127.0.0.1:3000`.

### 2. Edit Socket.IO Proxy Config

```bash
sudo vi /usr/local/AppCentral/nginx-1.18.0/data/conf/conf.d-available/webserver_proxy_pass.conf
```

Content should be:

```nginx
# Socket.IO WebSocket proxy
location /socket.io/ {
    proxy_pass http://localhost:3000/socket.io/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_cache_bypass $http_upgrade;
}
```

### 3. Edit Main HTTP Config

```bash
sudo vi /usr/local/AppCentral/nginx-1.18.0/data/conf/sites-available/http.conf
```

Find the `location / {}` block at the end of the server section and change it from empty to:

```nginx
location / {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_cache_bypass $http_upgrade;
}
```

**Note**: Only modify the `location /` block - leave everything else (server block, PHP config, includes) unchanged.

### 4. Test and Reload Nginx

```bash
# Test configuration syntax
sudo /usr/local/AppCentral/nginx-1.18.0/data/sbin/nginx -c /usr/local/AppCentral/nginx-1.18.0/data/conf/nginx.conf -t

# Reload nginx
sudo /usr/local/AppCentral/nginx-1.18.0/data/sbin/nginx -c /usr/local/AppCentral/nginx-1.18.0/data/conf/nginx.conf -s reload
```

### 5. Verify

Access `http://192.168.20.92/` in a browser - you should see the React Router 7 app.

## Vim Quick Reference

- `i` - Enter insert mode
- `Esc` - Exit insert mode
- `:wq` - Save and quit
- `:q!` - Quit without saving
- `dd` - Delete current line
- `gg` - Go to top of file
- `G` - Go to bottom of file

## Troubleshooting

### Config Test Fails with "duplicate location"

The `webserver_proxy_pass.conf` file likely has a `location /` block. Remove it and keep only the `location /socket.io/` block.

### Site Still Showing Old Static Content

1. Check Docker container is running: `docker compose ps`
2. Test direct access: `curl http://localhost:3000` (from NAS)
3. Check nginx is actually reloaded: `ps aux | grep nginx`
4. Clear browser cache or try incognito mode

### Cannot Connect to Backend API

The backend IP is hardcoded in multiple places. If the Pi IP changes from `192.168.20.59`, update:
- `client/app/socket.ts`
- `docker-compose.nas.yml` (VITE_BASE_URL)
- Re-build and re-deploy Docker container

## Alternative: Direct Port Access

If nginx configuration becomes too unstable, an alternative is to expose the Docker container on port 8080 and access it directly at `http://192.168.20.92:8080`:

```yaml
# In docker-compose.nas.yml
ports:
  - "8080:3000"  # Instead of 127.0.0.1:3000:3000
```

This bypasses nginx entirely but loses the benefits of a reverse proxy (standard port 80, centralized SSL termination, etc.).
